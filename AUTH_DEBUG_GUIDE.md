# دليل تصحيح مشاكل المصادقة

## المشكلة
كانت هناك مشاكل في نظام المصادقة حيث كانت الرموز المميزة (JWT tokens) تنتهي صلاحيتها ولكن الواجهة الأمامية لا تتعامل معها بشكل صحيح، مما يؤدي إلى أخطاء 401.

## الحلول المطبقة

### 1. إصلاح إعدادات JWT في الخادم
```python
SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(hours=24),  # زيادة مدة الرمز المميز
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),
    'ROTATE_REFRESH_TOKENS': False,  # إيقاف دوران الرموز
    'BLACKLIST_AFTER_ROTATION': False,  # إيقاف حظر الرموز
    'UPDATE_LAST_LOGIN': True,
}
```

### 2. تحسين آلية تحديث الرموز المميزة
- إضافة سجلات تفصيلية لتتبع عملية التحديث
- منع الحلقات اللانهائية في طلبات التحديث
- تحسين معالجة الأخطاء

### 3. أدوات التصحيح
تم إضافة لوحة تصحيح في أسفل يمين الشاشة (في وضع التطوير فقط) تحتوي على:

#### أزرار التصحيح:
- **Check Tokens**: فحص حالة الرموز المميزة الحالية
- **Auto Login**: تسجيل دخول تلقائي باستخدام بيانات المدير
- **Clear Auth**: مسح جميع بيانات المصادقة
- **Force Re-login**: إجبار إعادة تسجيل الدخول

## كيفية الاستخدام

### إذا واجهت أخطاء 401:
1. افتح وحدة تحكم المتصفح (F12)
2. اضغط على "Check Tokens" لرؤية حالة الرموز
3. إذا كانت الرموز مفقودة أو منتهية الصلاحية، اضغط "Auto Login"
4. إذا لم ينجح ذلك، اضغط "Clear Auth" ثم "Auto Login"

### بيانات الاعتماد للاختبار:
- **المدير**: admin@example.com / admin123
- **الطبيب**: doctor@example.com / doctor123
- **المريض**: patient@example.com / patient123

## ملاحظات مهمة
- أدوات التصحيح تظهر فقط في وضع التطوير
- يتم حفظ بيانات الاعتماد مؤقتاً للتصحيح (يجب إزالتها في الإنتاج)
- تم زيادة مدة صلاحية الرموز المميزة إلى 24 ساعة لتقليل المشاكل

## إزالة أدوات التصحيح للإنتاج
```javascript
// في Layout.jsx، احذف هذا السطر:
{process.env.NODE_ENV === 'development' && <AuthDebug />}

// في Login.jsx، احذف هذا الجزء:
if (process.env.NODE_ENV === 'development') {
  storeCredentials(formData.email, formData.password);
}
```
